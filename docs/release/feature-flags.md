# Правила выката фичей через feature flags

## Где хранятся флаги
- **Backend (FastAPI):**
  - Таблица `feature_flags` в базе данных. Флаги автоматически создаются при старте приложения по конфигу `FEATURE_FLAGS` или дефолтам (`newsletter_form`, `feedback_form`, `beta_tools_banner`).
  - Первичное наполнение происходит при старте приложения и в скрипте `app/seeding.py`, поэтому данные доступны как в проде, так и в тестовых окружениях.
- **Frontend (React):**
  - Базовые значения лежат в `src/featureFlags/config.ts`. Они применяются, если API недоступно или не успело ответить.
  - При загрузке страницы фронтенд запрашивает флаги с бэкенда (`GET /feature-flags`) и мержит их с конфигурацией.

## Как менять значения
- Продовые изменения вносятся через БД (админка/SQL/скрипты) — фронтенд подхватит их без релиза.
- Для локальной отладки можно передать переменную окружения `FEATURE_FLAGS` в формате JSON, например:
  ```bash
  FEATURE_FLAGS='{"newsletter_form": false, "beta_tools_banner": true}' uvicorn app.main:app
  ```
- При добавлении новой фичи добавьте ключ в:
  1. `app/core/config.py` (дефолт и валидация);
  2. `app/services/feature_flags.ensure_feature_flags` (создание записи);
  3. `src/featureFlags/config.ts` и использование в UI.

## Стратегия выката
1. **Beta / ограниченный запуск**
   - Включить флаг только для стенда или конкретного домена в БД.
   - Мониторить логи и метрики; при ошибках выключить флаг без релиза.
2. **Постепенный rollout**
   - Создать флаг в БД со значением `false`, задеплоить код.
   - Включить флаг на 5–10% трафика через SQL/админку (при появлении поддержки процентных флагов).
   - Увеличивать долю до 100%, затем удалить защитный код после стабилизации.
3. **A/B или продуктовые эксперименты**
   - Завести отдельный флаг на вариант фичи (`feature_x_v2`).
   - Прописать в аналитике события с атрибутом `feature_flag` для сегментации результатов.
4. **Фолбэк и откат**
   - Все UI-блоки обязаны иметь резервное состояние при `false` (заглушка/скелетон/ссылка на саппорт).
   - При критичных инцидентах достаточно переключить значение в БД или через env и перезапуск.

## Чек-лист перед выкатыванием
- [ ] Флаг есть в БД и имеет осмысательное описание.
- [ ] В UI есть fallback при `false` и корректный текст для пользователя.
- [ ] Метрики/логи завязаны на значение флага.
- [ ] План отката задокументирован в таске.
- [ ] После стабилизации — удалить лишний код и сам флаг.
